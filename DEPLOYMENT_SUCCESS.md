# ðŸš€ Vercel Monorepo Deployment Success Guide

## Overview
This document captures the proven solution for deploying pnpm monorepo applications to Vercel, specifically addressing the "Module not found" errors that occur even after proper pnpm detection.

## The Problem
Despite Vercel correctly detecting pnpm 8.15.0 and the monorepo structure, builds were failing with:
```
Module not found: Can't resolve '@ganger/auth'
```

## The Root Cause
Workspace packages were configured to export compiled JavaScript files from `dist/` directories:
```json
{
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": "./dist/index.js"
  }
}
```

However:
- `dist/` directories are gitignored and don't exist in Vercel's build environment
- Even when packages are built during install, the module resolution fails
- Next.js `transpilePackages` needs access to TypeScript source files

## The Solution
Update all workspace packages to export TypeScript source files directly, allowing Next.js to handle transpilation:

```json
{
  "main": "src/index.ts",
  "types": "src/index.ts",
  "exports": {
    ".": {
      "types": "./src/index.ts",
      "import": "./src/index.ts",
      "require": "./src/index.ts"
    }
  }
}
```

## Complete Working Configuration

### 1. Root `package.json`
```json
{
  "name": "ganger-platform",
  "packageManager": "pnpm@8.15.0",
  "workspaces": ["apps/*", "packages/*"]
}
```
**Critical**: Only the root should have `packageManager` field

### 2. Vercel Project Settings (API Configuration)
```bash
# Set via API for each project
{
  "rootDirectory": "apps/[app-name]",  # e.g., "apps/ai-receptionist"
  "framework": "nextjs",
  "buildCommand": "cd ../.. && pnpm -F @ganger/[app-name] build",
  "installCommand": "cd ../.. && NODE_ENV=development pnpm install --no-frozen-lockfile",
  "outputDirectory": ".next"
}

# Environment Variables
ENABLE_EXPERIMENTAL_COREPACK=1
```

### 3. App Configuration (`next.config.js`)
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  transpilePackages: [
    '@ganger/auth',
    '@ganger/db', 
    '@ganger/integrations',
    '@ganger/ui',
    '@ganger/utils'
  ],
  // Other Next.js config...
};

module.exports = nextConfig;
```

### 4. Workspace Package Configuration
Example for `packages/auth/package.json`:
```json
{
  "name": "@ganger/auth",
  "version": "0.1.0",
  "private": true,
  "main": "src/index.ts",
  "types": "src/index.ts",
  "exports": {
    ".": {
      "types": "./src/index.ts",
      "import": "./src/index.ts",
      "require": "./src/index.ts"
    },
    "./server": {
      "types": "./server.ts",
      "import": "./server.ts",
      "require": "./server.ts"
    }
  },
  "files": ["src/**/*"],
  "dependencies": {
    // dependencies
  }
}
```

## Deployment Checklist

### Pre-Deployment Verification
- [ ] Root `package.json` has `"packageManager": "pnpm@8.15.0"`
- [ ] No app-level `package.json` files contain `packageManager` field
- [ ] All workspace packages export TypeScript source files (not `dist/`)
- [ ] Each app's `next.config.js` includes `transpilePackages` array
- [ ] No `.next` directories are tracked in git
- [ ] Only `pnpm-lock.yaml` exists (no `package-lock.json` or `yarn.lock`)

### Vercel Project Setup
- [ ] `rootDirectory` set to `"apps/[app-name]"` (no leading/trailing slashes)
- [ ] `ENABLE_EXPERIMENTAL_COREPACK=1` environment variable set
- [ ] GitHub integration enabled for automatic deployments
- [ ] Correct build/install commands in `vercel.json`

### Build Success Indicators
- âœ… "Detected ENABLE_EXPERIMENTAL_COREPACK=1 and \"pnpm@8.15.0\" in package.json"
- âœ… "Detected `pnpm-lock.yaml` version 6 generated by pnpm@8.x"
- âœ… No "Module not found: Can't resolve '@ganger/*'" errors
- âœ… Build completes with "READY" state

## Successfully Deployed Apps
1. **inventory** - Medical supply tracking
2. **handouts** - Patient education materials  
3. **eos-l10** - Team management
4. **call-center-ops** - Call management
5. **integration-status** - Integration monitoring
6. **llm-demo** - AI demo application
7. **medication-auth** - Prior authorization
8. **ai-receptionist** - AI phone agent (newly fixed!)

## Remaining Apps to Deploy
Using the proven configuration above:
1. batch-closeout
2. checkin-kiosk
3. clinical-staffing
4. compliance-training
5. component-showcase
6. config-dashboard
7. pharma-scheduling
8. platform-dashboard
9. socials-reviews
10. staff
11. deployment-helper

## Key Insights

1. **pnpm Detection Works**: With `packageManager` in root only and `ENABLE_EXPERIMENTAL_COREPACK=1`, Vercel correctly detects pnpm.

2. **Source Files Required**: Next.js `transpilePackages` needs access to TypeScript source files, not compiled JavaScript.

3. **Git Integration Critical**: Projects created via Vercel UI have better default handling than API-created projects.

4. **Module Resolution**: The combination of `transpilePackages` + source file exports solves the workspace dependency resolution.

## Troubleshooting

### "Module not found" errors
- Verify workspace package exports point to `.ts` files
- Check `transpilePackages` includes all `@ganger/*` dependencies
- Ensure packages are listed in app's `package.json` dependencies

### "No Next.js version detected"  
- Confirm `next` is in app's dependencies
- Check `rootDirectory` is correctly set
- Verify no path double-nesting issues

### Build hangs or times out
- Check for circular dependencies
- Verify all workspace packages build successfully locally
- Monitor Vercel's build queue status

## Expert Validation
This approach has been validated by Vercel deployment experts as the correct solution for Next.js monorepos using pnpm workspaces. The key insight is that `transpilePackages` requires access to source TypeScript files rather than pre-compiled distributions.

---

*Last Updated: June 29, 2025*
*Status: Proven solution successfully deployed to ai-receptionist*