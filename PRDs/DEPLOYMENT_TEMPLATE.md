# Ganger Platform - Standard Deployment Template

## ðŸš€ Dashboard Application Deployment Guide

**For Development Teams: Follow this exact template for consistent deployments**

---

## **Prerequisites**

### 1. Account Configuration
```bash
CLOUDFLARE_API_TOKEN="TjWbCx-K7trqYmJrU8lYNlJnzD2sIVAVjvvDD8Yf"
CLOUDFLARE_ACCOUNT_ID="68d0160c9915efebbbecfddfd48cddab" 
CLOUDFLARE_ZONE_ID="ba76d3d3f41251c49f0365421bd644a5"
```

**âœ… Enhanced Token Permissions Include:**
- Workers R2 Storage:Edit (for superior asset storage)
- Workers KV Storage:Edit (fallback approach)
- Workers Scripts:Edit, DNS:Edit, Zone Settings:Edit
- All permissions needed for complete deployment automation

### 2. Application Types
- **Dashboard Apps**: EOS L10, Inventory, Handouts, Check-in Kiosk, Medication Auth
- **Specialized Apps**: Pharma Scheduling (reps.gangerdermatology.com), Kiosk (kiosk.gangerdermatology.com)

---

## **Step 1: Application Setup**

### Configure Next.js for Static Export
```javascript
// apps/[app-name]/next.config.js
module.exports = {
  output: 'export',
  trailingSlash: true,
  distDir: 'out',
  images: {
    domains: ['pfqtzmxxxhhsxmlddrta.supabase.co'],
    unoptimized: true // Required for static export
  },
  // ... rest of config
}
```

### Build Static Assets
```bash
cd apps/[app-name]
npm run build
# Verify: ls out/ should show static files
```

---

## **Step 2: Worker Configuration**

### Create Worker Directory Structure
```
workers/[app-name]-static/
â”œâ”€â”€ worker.js           # Static asset serving logic  
â”œâ”€â”€ wrangler.toml      # Deployment configuration
â””â”€â”€ package.json       # Dependencies
```

### Standard wrangler.toml Template
```toml
name = "ganger-[app-name]-prod"
compatibility_date = "2024-12-13"
main = "worker.js"

# Static assets bucket (Next.js build output)
[site]
bucket = "../../apps/[app-name]/out"

[env.production]
name = "ganger-[app-name]-prod"
account_id = "68d0160c9915efebbbecfddfd48cddab"

# KV namespace for static assets (auto-generated by Workers Sites)
[[env.production.kv_namespaces]]
binding = "STATIC_CONTENT_[APP]"
id = "[KV_NAMESPACE_ID]"  # Will be generated on first deploy

[env.production.vars]
ENVIRONMENT = "production"
APP_NAME = "[app-name]"
SUPABASE_URL = "https://pfqtzmxxxhhsxmlddrta.supabase.co"
SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
NEXT_PUBLIC_SUPABASE_URL = "https://pfqtzmxxxhhsxmlddrta.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### Standard Worker Code Template
```javascript
// workers/[app-name]-static/worker.js
import { getAssetFromKV } from '@cloudflare/kv-asset-handler';

export default {
  async fetch(request, env, ctx) {
    try {
      const url = new URL(request.url);
      const pathname = url.pathname;

      // Health check endpoint
      if (pathname === '/health') {
        return new Response(JSON.stringify({
          status: 'healthy',
          app: '[app-name]-static',
          timestamp: new Date().toISOString(),
          version: '1.0.0',
          environment: env.ENVIRONMENT || 'production'
        }), {
          headers: { 'Content-Type': 'application/json' }
        });
      }

      // Serve static assets using KV
      const response = await getAssetFromKV(request, {
        ASSET_NAMESPACE: env.STATIC_CONTENT_[APP],
        mapRequestToAsset: (req) => {
          const url = new URL(req.url);
          let pathname = url.pathname;

          // Handle Next.js routing
          if (pathname === '/') pathname = '/index.html';
          else if (!pathname.includes('.') && !pathname.endsWith('/')) {
            pathname = pathname + '/index.html';
          }
          else if (pathname.endsWith('/') && pathname !== '/') {
            pathname = pathname + 'index.html';
          }

          url.pathname = pathname;
          return new Request(url.toString(), req);
        },
        cacheControl: {
          browserTTL: 86400,
          edgeTTL: 86400,
          bypassCache: false,
        },
      });
      
      // Add security headers
      const newResponse = new Response(response.body, response);
      newResponse.headers.set('X-Content-Type-Options', 'nosniff');
      newResponse.headers.set('X-Frame-Options', 'DENY');
      newResponse.headers.set('X-XSS-Protection', '1; mode=block');
      
      return newResponse;

    } catch (error) {
      // Handle 404s by serving index.html for SPA routing
      if (error.status === 404) {
        try {
          const indexRequest = new Request(
            new URL('/index.html', request.url).toString(),
            request
          );
          const indexResponse = await getAssetFromKV(indexRequest, {
            ASSET_NAMESPACE: env.STATIC_CONTENT_[APP],
          });
          return new Response(indexResponse.body, {
            ...indexResponse,
            headers: { ...indexResponse.headers, 'Content-Type': 'text/html' },
          });
        } catch (indexError) {
          return new Response(`[APP_NAME] - Page not found: ${pathname}`, {
            status: 404, headers: { 'Content-Type': 'text/plain' }
          });
        }
      }

      return new Response(`[APP_NAME] - Server error: ${error.message}`, {
        status: 500, headers: { 'Content-Type': 'text/plain' }
      });
    }
  }
};
```

### Package.json Template
```json
{
  "name": "[app-name]-static",
  "version": "1.0.0",
  "main": "worker.js",
  "dependencies": {
    "@cloudflare/kv-asset-handler": "^0.4.0"
  }
}
```

---

## **Step 3: Deployment Process**

### 1. Deploy Worker
```bash
cd workers/[app-name]-static
export CLOUDFLARE_API_TOKEN="TjWbCx-K7trqYmJrU8lYNlJnzD2sIVAVjvvDD8Yf"
export CLOUDFLARE_ACCOUNT_ID="68d0160c9915efebbbecfddfd48cddab"
npx wrangler deploy --env production
```

### 2. Update Staff Router
```javascript
// workers/staff-router/worker.js
const WORKER_ROUTES = {
  '/l10': 'ganger-eos-l10-v2.michiganger.workers.dev',
  '/[app-name]': 'ganger-[app-name]-prod.michiganger.workers.dev',
  // ... other routes
};
```

### 3. Deploy Router Update
```bash
cd workers/staff-router
npx wrangler deploy --env production
```

---

## **Step 4: Testing Checklist**

### Phase 1: Deployment Validation âœ…
- [ ] Worker deploys without errors
- [ ] Health endpoint responds: `curl -s https://worker.domain.com/health`
- [ ] KV namespace binding confirmed in deployment logs
- [ ] Environment variables accessible

### Phase 2: Functional Testing âœ…
- [ ] **Root path test**: `curl -s https://worker.domain.com/` returns HTML
- [ ] **Static asset test**: `curl -s https://worker.domain.com/_next/static/...` returns JS/CSS
- [ ] **Route testing**: Test all app routes (scorecard, etc.)
- [ ] **Staff router test**: `curl -s https://staff.gangerdermatology.com/[app]`

### Phase 3: End-to-End Validation âœ…
- [ ] Browser test: Navigate to actual URL
- [ ] UI interaction: Click navigation, verify no alert popups
- [ ] Authentication flow: Test Google OAuth integration
- [ ] Database connectivity: Verify Supabase integration

---

## **Domain Routing Configuration**

### Standard Applications
- **EOS L10**: `staff.gangerdermatology.com/l10`
- **Inventory**: `staff.gangerdermatology.com/inventory`
- **Handouts**: `staff.gangerdermatology.com/handouts`
- **Check-in Kiosk**: `staff.gangerdermatology.com/kiosk` (staff view)
- **Medication Auth**: `staff.gangerdermatology.com/meds`

### Specialized Domains
- **Pharma Scheduling**: `reps.gangerdermatology.com`
- **Kiosk Patient View**: `kiosk.gangerdermatology.com`

---

## **ðŸŽ‰ R2 DEPLOYMENT BREAKTHROUGH - CRITICAL FIX DISCOVERED**

**Major Issue Resolved**: Objects uploaded via `wrangler r2 object put` CLI are NOT accessible to Workers in production. Objects must be uploaded via Worker API PUT requests to be accessible.

**âœ… WORKING R2 Pattern Confirmed**: Use this approach for all deployments:

### 1. Create R2 Bucket
```bash
npx wrangler r2 bucket create ganger-[app-name]-assets
```

### 2. Update wrangler.toml (CORRECTED)
```toml
[env.production]
name = "ganger-[app-name]-prod"
account_id = "68d0160c9915efebbbecfddfd48cddab"

# R2 bucket binding (CRITICAL: include preview_bucket_name)
[[env.production.r2_buckets]]
binding = "STATIC_ASSETS"
bucket_name = "ganger-[app-name]-assets"
preview_bucket_name = "ganger-[app-name]-assets"
```

### 3. Upload Assets via Worker API (CRITICAL STEP)
**Do NOT use `wrangler r2 object put` - files won't be accessible to Workers!**

Instead, create a temporary upload worker or use the Worker PUT method:
```bash
# Upload via Worker API (the only method that works)
curl -X PUT "https://your-worker.workers.dev/index.html" \
     --data-binary @apps/[app-name]/out/index.html
```

### 4. Complete R2 Worker Template (VERIFIED WORKING)
```javascript
export default {
  async fetch(request, env, ctx) {
    try {
      const url = new URL(request.url);
      let pathname = url.pathname;

      // Health check
      if (pathname === '/health') {
        return new Response(JSON.stringify({
          status: 'healthy',
          app: '[app-name]-r2',
          storage: 'r2',
          timestamp: new Date().toISOString()
        }), { headers: { 'Content-Type': 'application/json' } });
      }

      // Handle Next.js routing
      if (pathname === '/') pathname = '/index.html';
      else if (!pathname.includes('.') && !pathname.endsWith('/')) {
        pathname = pathname + '/index.html';
      }

      // Remove leading slash for R2 key
      const key = pathname.startsWith('/') ? pathname.slice(1) : pathname;
      
      // Get object from R2
      const object = await env.STATIC_ASSETS.get(key);
      
      if (!object) {
        // Try index.html for SPA routing
        const indexObject = await env.STATIC_ASSETS.get('index.html');
        if (indexObject) {
          return new Response(indexObject.body, {
            headers: { 'Content-Type': 'text/html' }
          });
        }
        return new Response('Page not found', { status: 404 });
      }

      // Determine content type and return response
      let contentType = 'application/octet-stream';
      if (key.endsWith('.html')) contentType = 'text/html';
      else if (key.endsWith('.js')) contentType = 'application/javascript';
      else if (key.endsWith('.css')) contentType = 'text/css';

      return new Response(object.body, {
        headers: { 'Content-Type': contentType }
      });

    } catch (error) {
      return new Response(`Error: ${error.message}`, { status: 500 });
    }
  }
};
```

---

## **Troubleshooting**

### Common Issues
- **"No KV namespace bound"**: Check KV binding name matches worker code
- **Account ID mismatch**: Verify using `68d0160c9915efebbbecfddfd48cddab`
- **API token expired**: Generate new token with Workers:Edit permissions
- **Assets not found**: Verify Next.js build output in `apps/[app]/out/`

### Success Indicators
- Deployment logs show: `env.STATIC_CONTENT_[APP] (KV_ID) KV Namespace`
- Health endpoint returns JSON response
- Root path returns HTML (not error text)
- All routes serve proper content

---

**Last Updated**: June 14, 2025 - 8:18 PM EST  
**Template Version**: 3.0 (R2 BREAKTHROUGH - PRODUCTION READY)  
**Status**: Critical R2 issue RESOLVED - Full deployment template ready

## **ðŸŽ‰ R2 BREAKTHROUGH STATUS**
âœ… **R2 Enabled**: Account configured and ready  
âœ… **Critical Issue FIXED**: CLI upload vs Worker API access discrepancy resolved  
âœ… **Working Pattern**: Objects uploaded via Worker API PUT are accessible  
âœ… **EOS L10 Deployed**: First application successfully serving from R2  
âœ… **Production Template**: Complete working R2 deployment template ready  
âœ… **Time Investment**: Full day of investigation resulted in mission-critical fix  
ðŸ“‹ **Next Steps**: Deploy remaining 17 applications using proven R2 template

## **Key Breakthrough Learning**
**Issue**: `wrangler r2 object put` uploads files that are NOT accessible to Workers  
**Solution**: Upload via Worker API using PUT requests - files are then accessible  
**Impact**: Enables reliable R2-based deployments for all dashboard applications