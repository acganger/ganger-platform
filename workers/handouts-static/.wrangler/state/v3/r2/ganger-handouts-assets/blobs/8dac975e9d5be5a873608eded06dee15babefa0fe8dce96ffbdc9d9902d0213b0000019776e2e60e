"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[649],{8649:function(e,t,i){var a=i(1635),n=i(5270);let r=null,s=null;function o(){return"https://pfqtzmxxxhhsxmlddrta.supabase.co"}let l=new Proxy({},{get:(e,t)=>(function(){if(r)return r;let e=o(),t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmcXR6bXh4eGhoc3htbGRkcnRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI5OTQ5NjQsImV4cCI6MjA0ODU3MDk2NH0.eLPNjjpDLG0GKVHCJ6eTSWWOFCJuIOkOsILI9HxZNLM";return e&&t?r=(0,a.createClient)(e,t):{auth:{getSession:()=>Promise.resolve({data:{session:null},error:null}),onAuthStateChange:()=>({data:{subscription:{unsubscribe:()=>{}}}})},from:()=>({select:()=>({eq:()=>({single:()=>Promise.resolve({data:null,error:{message:"Not available during build"}}),limit:()=>Promise.resolve({data:[],error:null})}),limit:()=>Promise.resolve({data:[],error:null}),order:()=>Promise.resolve({data:[],error:null})}),insert:()=>Promise.resolve({data:null,error:{message:"Not available during build"}}),update:()=>({eq:()=>Promise.resolve({data:null,error:{message:"Not available during build"}})}),delete:()=>({eq:()=>Promise.resolve({data:null,error:{message:"Not available during build"}})})}),rpc:()=>Promise.resolve({data:null,error:{message:"Not available during build"}})}})()[t]}),c=new Proxy({},{get:(e,t)=>(function(){if(s)return s;let e=o(),t=n.env.SUPABASE_SERVICE_ROLE_KEY;return e&&t?s=(0,a.createClient)(e,t):{auth:{admin:{createUser:()=>Promise.resolve({data:null,error:{message:"Not available during build"}}),updateUserById:()=>Promise.resolve({data:null,error:{message:"Not available during build"}}),deleteUser:()=>Promise.resolve({data:null,error:{message:"Not available during build"}})}},from:()=>({select:()=>({eq:()=>({single:()=>Promise.resolve({data:null,error:{message:"Not available during build"}}),limit:()=>Promise.resolve({data:[],error:null})}),limit:()=>Promise.resolve({data:[],error:null}),order:()=>Promise.resolve({data:[],error:null})}),insert:()=>Promise.resolve({data:null,error:{message:"Not available during build"}}),update:()=>({eq:()=>Promise.resolve({data:null,error:{message:"Not available during build"}})}),delete:()=>({eq:()=>Promise.resolve({data:null,error:{message:"Not available during build"}})})}),rpc:()=>Promise.resolve({data:null,error:{message:"Not available during build"}})}})()[t]}),d={maxConnections:10};class u{startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,console.log("\uD83D\uDD0D Database connection monitoring started"),this.monitoringInterval=setInterval(async()=>{await this.updateMetrics()},3e4))}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=void 0),this.isMonitoring=!1,console.log("\uD83D\uDED1 Database connection monitoring stopped")}async updateMetrics(){try{let{data:e,error:t}=await c.rpc("get_database_stats");if(t){this.metrics.connectionErrors++,console.warn("Failed to get database stats:",t);return}e&&(this.metrics.totalConnections=e.numbackends||0,this.metrics.lastHealthCheck=new Date),this.metrics.totalConnections>.8*d.maxConnections&&await this.alertConnectionPoolHigh()}catch(e){this.metrics.connectionErrors++,console.error("Connection monitoring error:",e)}}trackQuery(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.metrics.totalQueries++,t){this.metrics.failedQueries++;return}this.queryTimes.push(e),this.queryTimes.length>100&&(this.queryTimes=this.queryTimes.slice(-100)),this.metrics.averageQueryTime=this.queryTimes.reduce((e,t)=>e+t,0)/this.queryTimes.length,e>1e3&&(this.metrics.slowQueries++,console.warn("\uD83D\uDC0C Slow query detected: ".concat(e,"ms")))}async alertConnectionPoolHigh(){let e=Math.round(this.metrics.totalConnections/d.maxConnections*100);if(console.warn("⚠️ High connection pool utilization: ".concat(e,"% ")+"(".concat(this.metrics.totalConnections,"/").concat(d.maxConnections,")")),n.env.SLACK_WEBHOOK_URL)try{await fetch(n.env.SLACK_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:"\uD83D\uDEA8 Database Connection Alert: ".concat(e,"% pool utilization in ").concat("production")})})}catch(e){console.error("Failed to send connection alert:",e)}}getMetrics(){return{...this.metrics}}async healthCheck(){let e=[],t=this.metrics.totalConnections/d.maxConnections;t>.8&&e.push("High connection pool utilization: ".concat(Math.round(100*t),"%")),this.metrics.averageQueryTime>500&&e.push("High average query time: ".concat(Math.round(this.metrics.averageQueryTime),"ms"));let i=this.metrics.failedQueries/this.metrics.totalQueries;return i>.05&&e.push("High query error rate: ".concat(Math.round(100*i),"%")),{healthy:await m()&&0===e.length,metrics:this.getMetrics(),warnings:e}}constructor(){this.queryTimes=[],this.isMonitoring=!1,this.metrics={totalConnections:0,activeConnections:0,idleConnections:0,totalQueries:0,slowQueries:0,failedQueries:0,averageQueryTime:0,lastHealthCheck:new Date,connectionErrors:0}}}async function m(){try{let{data:e,error:t}=await l.from("users").select("id").limit(1);return!t}catch(e){return console.error("Database health check failed:",e),!1}}new u;class g{get client(){return this.useAdmin?c:l}async findById(e){let{data:t,error:i}=await this.client.from(this.tableName).select("*").eq("id",e).single();if(i){if("PGRST116"===i.code)return null;throw i}return t}async findMany(e){let t=this.client.from(this.tableName).select("*",{count:"exact"});if((null==e?void 0:e.filters)&&Object.entries(e.filters).forEach(e=>{let[i,a]=e;null!=a&&(t=t.eq(i,a))}),(null==e?void 0:e.orderBy)&&(t=t.order(e.orderBy.field,{ascending:"asc"===e.orderBy.direction})),null==e?void 0:e.limit){let i=e.offset||0;t=t.range(i,i+e.limit-1)}let{data:i,error:a,count:n}=await t;if(a)throw a;return{data:i||[],count:n||0,hasMore:null!=e&&!!e.limit&&(n||0)>(e.offset||0)+e.limit}}async create(e){let{data:t,error:i}=await this.client.from(this.tableName).insert(e).select().single();if(i)throw i;return t}async update(e,t){let{data:i,error:a}=await this.client.from(this.tableName).update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;return i}async delete(e){let{error:t}=await this.client.from(this.tableName).delete().eq("id",e);if(t)throw t}async deleteMany(e){let{error:t}=await this.client.from(this.tableName).delete().in("id",e);if(t)throw t}async exists(e){let{data:t,error:i}=await this.client.from(this.tableName).select("id").eq("id",e).single();return!i&&!!t}async count(e){let t=this.client.from(this.tableName).select("*",{count:"exact",head:!0});e&&Object.entries(e).forEach(e=>{let[i,a]=e;null!=a&&(t=t.eq(i,a))});let{count:i,error:a}=await t;if(a)throw a;return i||0}constructor(e,t=!1){this.tableName=e,this.useAdmin=t}}class h extends g{async findByEmail(e){let{data:t,error:i}=await this.client.from(this.tableName).select("*").eq("email",e).single();if(i){if("PGRST116"===i.code)return null;throw i}return t}async findByRole(e){let{data:t,error:i}=await this.client.from(this.tableName).select("*").eq("role",e).eq("is_active",!0);if(i)throw i;return t||[]}async findByLocation(e){let{data:t,error:i}=await this.client.from(this.tableName).select("*").contains("locations",[e]).eq("is_active",!0);if(i)throw i;return t||[]}async updateLastLogin(e){let{error:t}=await this.client.from(this.tableName).update({last_login:new Date().toISOString()}).eq("id",e);if(t)throw t}async updateLocations(e,t){return this.update(e,{locations:t})}async deactivateUser(e){return this.update(e,{is_active:!1})}async activateUser(e){return this.update(e,{is_active:!0})}async searchUsers(e){let{data:t,error:i}=await this.client.from(this.tableName).select("*").or("name.ilike.%".concat(e,"%,email.ilike.%").concat(e,"%")).eq("is_active",!0).limit(50);if(i)throw i;return t||[]}constructor(){super("users",!0)}}new h;class p extends g{async findActiveLocations(){let{data:e,error:t}=await this.client.from(this.tableName).select("*").eq("is_active",!0).order("name",{ascending:!0});if(t)throw t;return e||[]}async findByState(e){let{data:t,error:i}=await this.client.from(this.tableName).select("*").eq("state",e).eq("is_active",!0).order("city",{ascending:!0});if(i)throw i;return t||[]}async findByCity(e,t){let{data:i,error:a}=await this.client.from(this.tableName).select("*").eq("city",e).eq("state",t).eq("is_active",!0);if(a)throw a;return i||[]}async searchLocations(e){let{data:t,error:i}=await this.client.from(this.tableName).select("*").or("name.ilike.%".concat(e,"%,city.ilike.%").concat(e,"%,address.ilike.%").concat(e,"%")).eq("is_active",!0).limit(50);if(i)throw i;return t||[]}async updateSettings(e,t){return this.update(e,{settings:t})}constructor(){super("locations")}}new p;class z extends g{async logAction(e,t,i,a,n,r,s){return this.create({user_id:e,action:t,resource_type:i,resource_id:a,metadata:n,ip_address:r,user_agent:s})}async getLogsByUser(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,{data:i}=await this.findMany({filters:{user_id:e},orderBy:{field:"created_at",direction:"desc"},limit:t});return i}async getLogsByResource(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100,{data:a}=await this.findMany({filters:{resource_type:e,resource_id:t},orderBy:{field:"created_at",direction:"desc"},limit:i});return a}async getLogsByAction(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,{data:i}=await this.findMany({filters:{action:e},orderBy:{field:"created_at",direction:"desc"},limit:t});return i}async getLogsByDateRange(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,{data:a,error:n}=await this.client.from(this.tableName).select("*").gte("created_at",e).lte("created_at",t).order("created_at",{ascending:!1}).limit(i);if(n)throw n;return a||[]}async cleanupOldLogs(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:365,t=new Date;t.setDate(t.getDate()-e);let{count:i,error:a}=await this.client.from(this.tableName).delete({count:"exact"}).lt("created_at",t.toISOString());if(a)throw a;return i||0}constructor(){super("audit_logs",!0)}}new z;var y=i(6294);let _=y.z.object({id:y.z.string().uuid(),created_at:y.z.string().datetime(),updated_at:y.z.string().datetime()}),f=y.z.enum(["staff","manager","superadmin","pharma_rep","patient","vinya_tech"]);_.extend({email:y.z.string().email(),name:y.z.string().optional(),avatar_url:y.z.string().url().optional(),role:f,locations:y.z.array(y.z.string().uuid()),is_active:y.z.boolean(),last_login:y.z.string().datetime().optional(),metadata:y.z.record(y.z.any()).optional()}).omit({id:!0,created_at:!0,updated_at:!0}).partial(),_.extend({name:y.z.string().min(1),address:y.z.string().min(1),city:y.z.string().min(1),state:y.z.string().length(2),zip_code:y.z.string().regex(/^\d{5}(-\d{4})?$/),phone:y.z.string().regex(/^\+?[1-9]\d{1,14}$/).optional(),email:y.z.string().email().optional(),timezone:y.z.string(),is_active:y.z.boolean(),settings:y.z.record(y.z.any()).optional()}).omit({id:!0,created_at:!0,updated_at:!0}).partial(),_.extend({user_id:y.z.string().uuid().optional(),action:y.z.string().min(1),resource_type:y.z.string().min(1),resource_id:y.z.string().uuid().optional(),metadata:y.z.record(y.z.any()).optional(),ip_address:y.z.string().ip().optional(),user_agent:y.z.string().optional()}).omit({id:!0,created_at:!0,updated_at:!0});let v=y.z.enum(["info","success","warning","error","reminder"]);_.extend({user_id:y.z.string().uuid(),title:y.z.string().min(1),message:y.z.string().min(1),type:v,read_at:y.z.string().datetime().optional(),action_url:y.z.string().url().optional(),metadata:y.z.record(y.z.any()).optional()}).omit({id:!0,created_at:!0,updated_at:!0}),_.extend({user_id:y.z.string().uuid(),filename:y.z.string().min(1),original_name:y.z.string().min(1),mime_type:y.z.string(),file_size:y.z.number().positive(),storage_path:y.z.string().min(1),public_url:y.z.string().url().optional(),metadata:y.z.record(y.z.any()).optional(),is_public:y.z.boolean()}).omit({id:!0,created_at:!0,updated_at:!0}),_.extend({name:y.z.string().min(1),description:y.z.string().optional(),sku:y.z.string().min(1),barcode:y.z.string().optional(),category:y.z.string().min(1),vendor:y.z.string().min(1),unit_price:y.z.number().nonnegative(),quantity_on_hand:y.z.number().nonnegative(),reorder_level:y.z.number().nonnegative(),location_id:y.z.string().uuid(),is_active:y.z.boolean(),metadata:y.z.record(y.z.any()).optional()}).omit({id:!0,created_at:!0,updated_at:!0}),_.extend({name:y.z.string().min(1),description:y.z.string().optional(),template_type:y.z.string().min(1),content:y.z.string().min(1),variables:y.z.array(y.z.string()),category:y.z.string().min(1),is_active:y.z.boolean(),created_by:y.z.string().uuid(),metadata:y.z.record(y.z.any()).optional()}).omit({id:!0,created_at:!0,updated_at:!0}),_.extend({first_name:y.z.string().min(1),last_name:y.z.string().min(1),date_of_birth:y.z.string().date(),email:y.z.string().email().optional(),phone:y.z.string().regex(/^\+?[1-9]\d{1,14}$/).optional(),address:y.z.string().optional(),city:y.z.string().optional(),state:y.z.string().length(2).optional(),zip_code:y.z.string().regex(/^\d{5}(-\d{4})?$/).optional(),mrn:y.z.string().min(1),insurance_info:y.z.record(y.z.any()).optional(),emergency_contact:y.z.record(y.z.any()).optional(),metadata:y.z.record(y.z.any()).optional()}).omit({id:!0,created_at:!0,updated_at:!0});let b=y.z.enum(["scheduled","confirmed","in_progress","completed","cancelled","no_show"]);_.extend({patient_id:y.z.string().uuid(),provider_id:y.z.string().uuid(),location_id:y.z.string().uuid(),appointment_type:y.z.string().min(1),scheduled_at:y.z.string().datetime(),duration_minutes:y.z.number().positive(),status:b,notes:y.z.string().optional(),metadata:y.z.record(y.z.any()).optional()}).omit({id:!0,created_at:!0,updated_at:!0}),y.z.object({limit:y.z.number().positive().optional(),offset:y.z.number().nonnegative().optional(),orderBy:y.z.object({field:y.z.string(),direction:y.z.enum(["asc","desc"])}).optional(),filters:y.z.record(y.z.any()).optional()})}}]);